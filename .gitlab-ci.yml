image: node:12-alpine

stages:
    - dependencies
    - test
dependencies:
    stage: dependencies
    script:
        - npm install
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules
        policy: pull-push
lint:
    stage: test
    allow_failure: false
    script:
        - npm run lint
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules
        policy: pull
test:
    stage: test
    allow_failure: false
    script:
        - npm run test:coverage
    coverage: '/Lines \W+: (\d+\.\d+)%.*/'
    artifacts:
        paths:
            - coverage/
    cache:
        key:
            files:
                - package-lock.json
        paths:
            - node_modules
        policy: pull
sonar:
    stage: test
    before_script:
        - npm install -g sonarqube-scanner
    script:
        - sonar-scanner
          -Dsonar.projectKey=demo
          -Dsonar.organization=everflux-github
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.login=covfefe
          -Dsonar.typescript.lcov.reportPaths=coverage/lcov/lcov.info
          -Dsonar.sourceEncoding=UTF-8
          -Dsonar.sources=src/app
          -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts
          -Dsonar.tests=src/app
          -Dsonar.test.inclusions=**/*.spec.ts
